- alias: Master Automation Strategy
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_assistant_feed_in_price
      above: 1.00
  condition:
    - condition: state
      entity_id: binary_sensor.home_assistant_price_spike
      state: 'on'
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 0

- alias: Immediate Spike Discharge
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_assistant_feed_in_price
      above: 0.40
  condition:
    - condition: state
      entity_id: binary_sensor.home_assistant_price_spike
      state: 'on'
    - condition: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      above: 40
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 15000

- alias: Secondary Rule Discharge
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_assistant_feed_in_price
      above: 0.15
  condition:
    - condition: numeric_state
      entity_id: sensor.home_automation_solar_power
      below: 2000
    - condition: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      above: 40
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 15000

- alias: Secondary Rule Stop Discharge
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      below: 41
  condition:
    - condition: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      below: 41
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 0

- alias: Grid Backup Charge 1 PM
  trigger:
    - platform: time
      at: '13:00:00'
  condition:
    - condition: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      below: 40
    - condition: numeric_state
      entity_id: sensor.home_assistant_general_price
      below: 0.06
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_min_soc_on_grid
      data:
        value: 50

- alias: Grid Backup Charge Stop 2 PM
  trigger:
    - platform: time
      at: '14:00:00'
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_min_soc_on_grid
      data:
        value: 0

- alias: Negative Pricing Curtail Solar
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_assistant_feed_in_price
      below: -0.01
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_charge_power
      data:
        value: 0
    - service: number.set_value
      target:
        entity_id: number.home_automation_max_charge_current
      data:
        value: 15000

- alias: Critical Protection Low SOC
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      below: 11
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 0

- alias: Critical Protection Resume
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      above: 14
  condition:
    - condition: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      above: 14
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 15000

- alias: Solar Priority Disable Discharge
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_automation_solar_power
      above: 2000
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 0

- alias: Solar Priority Resume Discharge
  trigger:
    - platform: numeric_state
      entity_id: sensor.home_automation_solar_power
      below: 1999
  condition:
    - condition: numeric_state
      entity_id: sensor.home_assistant_feed_in_price
      above: 0.15
    - condition: numeric_state
      entity_id: sensor.home_automation_battery_soc_1
      above: 40
  action:
    - service: number.set_value
      target:
        entity_id: number.home_automation_force_discharge_power
      data:
        value: 15000